<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Bob Ippolito" />
  <title>Random Choice</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="reveal.js/css/reveal.min.css"/>
    <style type="text/css">code{white-space: pre;}</style>
    <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
    </style>
    <link rel="stylesheet" href="reveal.js/css/theme/simple.css" id="theme">
  <link rel="stylesheet" media="print" href="reveal.js/css/print/pdf.css" />
  <!--[if lt IE 9]>
  <script src="reveal.js/lib/js/html5shiv.js"></script>
  <![endif]-->
    <link rel="stylesheet" href="css/slides.css"/>
    <script src="d3/d3.min.js"></script>
    <script src="js/slides.js"></script>
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section>
    <h1 class="title">Random Choice</h1>
    <h2 class="author">Bob Ippolito</h2>
    <h3 class="date">October 2013</h3>
</section>

<section id="why-this-talk" class="slide level1">
<h1>Why this talk?</h1>
<ul>
<li>I was rewriting an IRC bot</li>
<li>He &quot;learns&quot; how to chat</li>
<li>Brain is based on Markov chains</li>
<li>Random choice is essential to this and many other interesting applications</li>
</ul>
</section>
<section id="andrey-andreyevich-markov" class="slide level1">
<h1>Andrey Andreyevich Markov</h1>
<!-- http://en.wikipedia.org/wiki/File:AAMarkov.jpg -->
<figure>
<img src="img/AAMarkov.jpg" alt="Андре́й Андре́евич Ма́рков" /><figcaption>Андре́й Андре́евич Ма́рков</figcaption>
</figure>
</section>
<section id="markov-chain" class="slide level1">
<h1>Markov chain</h1>
<!-- http://en.wikipedia.org/wiki/File:Markovkate_01.svg -->
<figure>
<img src="img/Markovkate_01.svg" alt="Markov Chain" /><figcaption>Markov Chain</figcaption>
</figure>
</section>
<section id="markov-text-generator" class="slide level1">
<h1>Markov text generator</h1>
<ul>
<li>Each step in a markov chain model makes a random choice</li>
<li>For the IRC bot, the number of word choices can be very large</li>
<li>Previous implementation was very simple, but too inefficient</li>
<li>Used too much memory, had to be retired years ago</li>
</ul>
</section>
<section id="really" class="slide level1">
<h1>Really?</h1>
<ul>
<li>(Most) ad servers also use random choice</li>
<li>Mochi Media built this kind of ad server in Erlang</li>
<li>Was fun to come up with an efficent way to do it</li>
<li>Note that Markov models weren't used in our ad server</li>
<li>… but random choice is common to both</li>
</ul>
</section>
<section id="erlangs-random-module" class="slide level1">
<h1>Erlang's <code>random</code> module</h1>
<ul>
<li>Wichmann-Hill AS183 algorithm from 1982</li>
<li>… designed for 16 bit computers with limited arithmetic</li>
<li>It has poor results and you probably shouldn't use it</li>
<li>Consider the <code>crypto</code> module</li>
<li>… or a third party library (<a href="https://github.com/jj1bdx/sfmt-erlang">sfmt-erlang</a>)</li>
<li>Despite this, I will use <code>random</code> for the examples</li>
</ul>
</section>
<section id="fair-coin-code" class="slide level1">
<h1>Fair coin</h1>
<ul>
<li><code>uniform()</code> returns a float <code>0.0 ≤ X &amp;lt; 1.0</code></li>
<li>○ (heads) when <code>X &amp;lt; 0.5</code></li>
<li>● (tails) otherwise</li>
</ul>
</section>
<section id="fair-coin" class="slide level1">
<h1>Fair coin</h1>
<div class="demo">
  <button>
Flip Coin
</button>
  <h3 class="nomargin">
X = <span class="x">…</span>
</h3>
  <p class="heads big">
○ (heads), X &lt; 0.5
</p>
  <p class="tails big">
● (tails), X ≥ 0.5
</p>
</div>

</section>
<section id="die-roll-code" class="slide level1">
<h1>Die roll</h1>
<ul>
<li><code>uniform(N)</code> returns an integer <code>1 ≤ X ≤ N</code></li>
<li><code>uniform(N) -&gt; 1 + trunc(N * uniform()).</code></li>
</ul>
</section>
<section id="die-roll" class="slide level1">
<h1>Die roll</h1>
<div class="demo">
<button>
Roll Die
</button>
  <h3 class="nomargin">
X = <span class="x">…</span>
</h3>
  
<span class="die big"></span>
</div>
</section>
<section id="unweighted-selection-code" class="slide level1">
<h1>Random selection without replacement</h1>
<pre class="sourceCode erlang"><code class="sourceCode erlang"><span class="fu">choose(</span><span class="dt">L</span><span class="fu">)</span> <span class="kw">-&gt;</span>
  <span class="dt">Nth</span> <span class="kw">=</span> <span class="fu">random:uniform(length(</span><span class="dt">L</span><span class="fu">)),</span>
  <span class="fu">{</span><span class="dt">H</span><span class="fu">,</span> <span class="fu">[</span><span class="dt">Choice</span> <span class="fu">|</span> <span class="dt">T</span><span class="fu">]}</span> <span class="kw">=</span> <span class="fu">lists:split(</span><span class="dt">Nth</span><span class="fu">,</span> <span class="dt">L</span><span class="fu">),</span>
  <span class="fu">{</span><span class="dt">Choice</span><span class="fu">,</span> <span class="dt">H</span> <span class="kw">++</span> <span class="dt">T</span><span class="fu">}.</span></code></pre>
</section>
<section id="unweighted-selection-notes" class="slide level1">
<h1>Random selection without replacement</h1>
<ul>
<li>Can be used to shuffle a list (very slowly)</li>
<li>Or simulate a deck of cards</li>
<li>Not used by our Markov model, but worthy of demonstration</li>
</ul>
</section>
<section id="unweighted-selection" class="slide level1">
<h1>Random selection without replacement</h1>
<div class="demo">
<button>
Select
</button>
  <h3 class="nomargin">
Selections =
</h3>
  
<span class="selections big"> </span>
<h3 class="nomargin">
L =
</h3>
  
<span class="l big"> </span>
</div>
</section>
<section id="weighted-selection" class="slide level1">
<h1>Weighted selection without replacement</h1>
<ul>
<li><p><code>{sum(Weight), [{Key, Weight}, …]}</code></p>
<pre class="sourceCode erlang"><code class="sourceCode erlang"><span class="fu">weight_split(</span><span class="dt">N</span><span class="fu">,</span> <span class="dt">L</span><span class="fu">)</span> <span class="kw">-&gt;</span> <span class="fu">weight_split(</span><span class="dt">N</span><span class="fu">,</span> <span class="dt">L</span><span class="fu">,</span> <span class="fu">[]).</span>
<span class="fu">weight_split(</span><span class="dt">N</span><span class="fu">,</span> <span class="dt">L</span><span class="fu">,</span> <span class="fu">[</span><span class="dt">H</span><span class="kw">=</span><span class="fu">{</span><span class="dt">K</span><span class="fu">,</span> <span class="dt">W</span><span class="fu">}</span> <span class="fu">|</span> <span class="dt">T</span><span class="fu">],</span> <span class="dt">Acc</span><span class="fu">)</span> <span class="kw">-&gt;</span>
  <span class="kw">case</span> <span class="dt">N</span> <span class="kw">-</span> <span class="dt">W</span> <span class="kw">of</span>
    <span class="dt">N1</span> <span class="ch">when</span> <span class="dt">N1</span> <span class="kw">&gt;</span> <span class="dv">0</span> <span class="kw">-&gt;</span>
      <span class="fu">weight_split(</span><span class="dt">N1</span><span class="fu">,</span> <span class="dt">T</span><span class="fu">,</span> <span class="fu">[</span><span class="dt">H</span> <span class="fu">|</span> <span class="dt">Acc</span><span class="fu">]);</span>
    <span class="dt">_</span> <span class="kw">-&gt;</span>
      <span class="fu">{</span><span class="dt">K</span><span class="fu">,</span> <span class="fu">lists:reverse(</span><span class="dt">Acc</span><span class="fu">,</span> <span class="dt">T</span><span class="fu">)}</span>
  <span class="kw">end</span><span class="fu">.</span></code></pre></li>
</ul>
</section>
<section id="unweighted-selection-repl-notes" class="slide level1">
<h1>Random selection with replacement</h1>
<pre class="sourceCode erlang"><code class="sourceCode erlang"><span class="fu">choose(</span><span class="dt">L</span><span class="fu">)</span> <span class="kw">-&gt;</span>
  <span class="fu">lists:nth(random:uniform(length(</span><span class="dt">L</span><span class="fu">)),</span> <span class="dt">L</span><span class="fu">).</span></code></pre>
<ul>
<li>Does not change list</li>
<li>Similar to rolling a die</li>
</ul>
</section>
<section id="unweighted-selection-repl" class="slide level1">
<h1>Random selection with replacement</h1>
<div class="demo selection-with-repl" data-initial="[&quot;☃&quot;, &quot;♖&quot;, &quot;♗&quot;, &quot;☺&quot;, &quot;✈&quot;, &quot;☭&quot;]">
<button>
Select
</button>
  <h3 class="nomargin">
Selections =
</h3>
  
<span class="selections big"> </span>
<h3 class="nomargin">
L =
</h3>
  
<span class="l big"> </span>
</div>
</section>
<section id="weighted-selection-repl-1" class="slide level1">
<h1>Weighted selection, naive</h1>
<ul>
<li>With replacement, weight can be implemented simply</li>
<li>Just add the item to the list multiple times</li>
<li><code>[a, a, a, b, c, d]</code></li>
<li>50% <code>a</code>, ~16.6% <code>b</code>, …</li>
</ul>
</section>
<section id="weighted-selection-repl-1" class="slide level1">
<h1>Weighted selection with replacement</h1>
<div class="demo selection-with-repl" data-initial="[&quot;☃&quot;, &quot;☃&quot;, &quot;☃&quot;, &quot;☺&quot;, &quot;✈&quot;, &quot;☭&quot;]">
<button>
Select
</button>
  <h3 class="nomargin">
Selections =
</h3>
  
<span class="selections big"> </span>
<h3 class="nomargin">
L =
</h3>
  
<span class="l big"> </span>
</div>
</section>
<section id="weighted-selection-repl-2-notes" class="slide level1">
<h1>Optimizing for memory</h1>
<ul>
<li>Naive solution uses a lot of memory</li>
<li>Can do better by counting each unique choice</li>
<li><code>{6, [{a, 3}, {b, 1}, {c, 1}, {d, 1}]}</code></li>
<li>Tradeoff - it's harder to seek to Nth choice</li>
</ul>
</section>
<section id="alias-notes" class="slide level1">
<h1>Alias method</h1>
<ul>
<li>Create N coins, one for each unique choice</li>
<li>Choose coin (by die roll), then flip weighted coin</li>
<li>Uses O(N) memory, has O(1) selection!</li>
</ul>
</section>
<section id="alias" class="slide level1">
<h1>Alias method</h1>
<div class="demo">
<div style="float: left">
  <button>
Choose
</button>
  <h3>
Die: <span class="die"></span>
</h3>
  <h3>
Coin: <span class="coin"></span>
</h3>
</div>
<table style="float: right">
  <thead>
    <tr><th>
head
</th><th>
tail
</th></tr>
    </thead>
  <tbody>
    <tr><td>
<tt>a</tt> 1
</td><td>
<tt>undefined</tt>
</td></tr>
    <tr><td>
<tt>b</tt> ⅔
</td><td>
<tt>a</tt> ⅓
</td></tr>
    <tr><td>
<tt>c</tt> ⅔
</td><td>
<tt>a</tt> ⅓
</td></tr>
    <tr><td>
<tt>d</tt> ⅔
</td><td>
<tt>a</tt> ⅓
</td></tr>
  </tbody>
</table>
</div>

</section>
<section id="handling-updates" class="slide level1">
<h1>Handling updates</h1>
<ul>
<li>For our IRC bot, the choices update for every word of text</li>
<li>Alias method is <code>O(n)</code> to update</li>
<li>High <code>O(n)</code> garbage, no sharing at all</li>
</ul>
</section>
<section id="naive-tree-update" class="slide level1">
<h1>Using a tree</h1>
<ul>
<li>Can build a tree for efficient updates</li>
<li>Fast <code>O(log n)</code> updates</li>
<li>Low <code>O(log n)</code> garbage, good sharing</li>
<li>Slow <code>O(n)</code> seeks, since sort is by key</li>
</ul>
</section>
<section id="max-heap-notes" class="slide level1">
<h1>Simple max heap</h1>
<p>Seems to be a good compromise between speed and memory Highest weights first Highest weights are most likely to be updated Worst case <code>O(n)</code> for every operation But very good common case, near head of the list</p>
</section>
<section id="max-heap" class="slide level1">
<h1>Simple max heap</h1>
<div class="demo">
<div style="float: left">
  <button>
Choose
</button>
  <form>
  
<input type="text" placeholder="Enter words" /><br /> <span class="big output"></span>
</form>
</div>
<table style="float: right">
  <thead>
    <tr><th>
Key 
</th><th>
Weight
</th></tr>
    </thead>
  <tbody>
  </tbody>
</table>
</div>

</section>
<section id="info" class="slide level1">
<h1>Questions?</h1>
<h3>
Slides:<br/>   <a href="http://bob.ippoli.to/rndchoice_efl_2012">etrepum.github.com/rndchoice_efl_2012</a>
</h3>
<h3>
Code:<br/>   <a href="http://github.com/etrepum/rndchoice_efl_2012">github.com/etrepum/rndchoice_efl_2012</a>
</h3>
<h3>
Twitter:<br/>   <a href="http://twitter.com/etrepum"><span class="citation" data-cites="etrepum">@etrepum</span></a>
</h3>


</section>
    </div>
  </div>

  <script src="reveal.js/lib/js/head.min.js"></script>
  <script src="reveal.js/js/reveal.min.js"></script>

  <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: false,
        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
//          { src: 'reveal.js/plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; }, }
//          { src: 'reveal.js/plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
]});
    </script>
  </body>
</html>
